### 现象：

为什么容器内磁盘读写不稳定？

### 原因：

- 时间波动是因为 Dirty Pages / Total Memory 占比高的影响么？
  - dirty_background_ratio: 当 Dirty Pages / Total Memory 占比超过这个值时, 内核 flush 线程就会把 dirty pages 刷到磁盘里
  - dirty_background_bytes: 当 Dirty Pages 超过这个值时, 内核 flush 线程就会把 dirty pages 刷到磁盘里
  - `dirty_ratio`: 当 Dirty Pages / Total Memory 占比超过这个值时, 这时候正在执行 Buffered I/O 写文件的进程就会被阻塞住
  - `dirty_bytes`: 当 Dirty Pages 超过这个值时, 这时候正在执行 Buffered I/O 写文件的进程就会被阻塞住
  - dirty_writeback_centisecs: 缺省值是 500, 它表示每 5 秒钟会唤醒内核的 flush 线程来处理 dirty pages
  - dirty_expire_centisecs: 缺省值是 30000, 它表示当一个 dirty page 超过这个时间没有被访问到, 就会被认为是过期的, 会被内核的 flush 线程刷到磁盘里

那是不是因为 dirty pages 很多, 超过了 dirty_ratio 或 dirty_bytes 导致写进程被阻塞住呢？

```shell
# 写入一个 1G 的文件
# dd if=/dev/zero of=/tmp/test1/test1.log bs=4096 count=2621440

# sudo ./run_iowrite.sh
...
4087: 121.338µs
4088: 79.273µs
4089: 115.72µs
4090: 63.695µs
4091: 87.967µs
4092: 41.995µs
4093: 118.514µs
4094: 64.034µs
4095: 104.127µs

# 波动很大 几十微妙~几百微秒, 但 dirty pages 并未超过 dirty_ratio
# watch -n 1 "cat /proc/vmstat | grep dirty"
Every 1.0s: cat /proc/vmstat | grep dirty

nr_dirty 236
nr_dirty_threshold 125644
nr_dirty_background_threshold 62745


# perf record -a -g -p <pid>
```

### 解决方法：

```shell

```
