### 现象：

为什么容器内磁盘读写不稳定？

### 原因：

- 多个容器同时读写节点上的同一块磁盘, 那么它们的磁盘读写相互之间影响

```shell 复现
# 一个容器写入磁盘
# ./fio/run_fio_in_one.sh

# 查看写入的结果
/tmp/fio_test1.log: (g=0): rw=write, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1
fio-3.7
Starting 1 process
/tmp/fio_test1.log: Laying out IO file (1 file / 1024MiB)

/tmp/fio_test1.log: (groupid=0, jobs=1): err= 0: pid=12: Wed Dec 24 08:23:47 2025
  write: IOPS=1174, BW=4699KiB/s (4812kB/s)(1024MiB/223137msec)

# 查看写入的性能
# iostat -xz 10


# 两个容器同时写入磁盘
# ./fio/run_fio_in_two.sh

# 查看写入的结果
 /tmp/fio_test1.log: (g=0): rw=write, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1
fio-3.7
Starting 1 process
/tmp/fio_test1.log: Laying out IO file (1 file 1024MiB)
/tmp/fio_test1.log: (groupid=0, jobs=1): err= 0: pid=12: Wed Dec 24 08:42:36 2025
  write: IOPS=1012, BW=4050KiB/s (4147kB/s)(1024MiB/258891msec)

/tmp/fio_test2.log: (g=0): rw=write, bs=(R) 4096B-4096B, (W) 4096B-4096B, (T) 4096B-4096B, ioengine=libaio, iodepth=1
fio-3.7
Starting 1 process
/tmp/fio_test2.log: Laying out IO file (1 file / 1024MiB)
/tmp/fio_test2.log: (groupid=0, jobs=1): err= 0: pid=12: Wed Dec 24 08:42:43 2025
  write: IOPS=1011, BW=4047KiB/s (4144kB/s)(1024MiB/259110msec)

# 查看写入的性能
# iostat -xz 10


```

### 解决方法：

- IOPS
- Throughput == BW == BPS
- Blkio Cgroup
  - blkio.throttle.read_iops_device
  - blkio.throttle.read_bps_device
  - blkio.throttle.write_iops_device
  - blkio.throttle.write_bps_device
  - blkio 在 Cgroups v1 里不能限制 Buffered I/O
  - blkio 在 Cgroups v2 里可以限制 Buffered I/O

```shell
# blkio.throttle.read_bps_device blkio.throttle.write_bps_device 设置为 1M
# ./fio/run_fio_in_one_blkio.sh

# 查看写入的结果
/tmp/fio_test1.log: (groupid=0, jobs=1): err= 0: pid=19: Wed Dec 24 09:30:56 2025
  write: IOPS=255, BW=1022KiB/s (1047kB/s)(10.0MiB/10017msec)
# 查看读取的结果
/tmp/fio_test1.log: (groupid=0, jobs=1): err= 0: pid=31: Wed Dec 24 09:31:07 2025
   read: IOPS=255, BW=1022KiB/s (1047kB/s)(10.0MiB/10017msec)
```
